<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™ºéŸ³å­¦ç¿’è€…ã®å¿…ä¿®å˜èªå¸³</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    h2 {
      font-size: 1.6em;
      margin: 15px 0;
    }
    img {
      max-width: 95%;  /* ã‚¹ãƒãƒ›æ¨ªå¹…ã„ã£ã±ã„ */
      height: auto;
      margin: 20px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    button {
      font-size: 1.3em;
      padding: 14px 22px;
      flex: 1;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      color: white;
    }
    button.green { background: #28a745; }
    button.red { background: #dc3545; }
    button.blue { background: #007bff; }
    button.orange { background: #fd7e14; }
    button.gray { background: #6c757d; }
    /* å˜èªãƒªã‚¹ãƒˆ */
    .list {
      max-width: 600px;
      margin: 10px auto;
      text-align: left;
      max-height: 400px;  /* å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      background: #fafafa;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 1.1em;
    }
    .word-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .play-icon {
      cursor: pointer;
      font-size: 1.3em;
    }
  </style>
</head>
<body>
  <h2 id="wordTitle">ç™ºéŸ³å­¦ç¿’è€…ã®å¿…ä¿®å˜èªå¸³</h2>
  <img id="wordImage" src="" alt="Word image">

  <!-- ğŸ›ï¸ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
  <div class="controls">
    <!-- é€Ÿåº¦èª¿æ•´ -->
    <div class="row">
      <button class="gray" onclick="setSpeed(0.5)">x0.5</button>
      <button class="gray" onclick="setSpeed(0.75)">x0.75</button>
      <button class="gray" onclick="setSpeed(1)">x1</button>
    </div>
    <!-- å†ç”Ÿæ“ä½œ -->
    <div class="row">
      <button class="blue" onclick="prevWord()">â¬…</button>
      <button class="green" onclick="togglePlay()">â–¶ï¸</button>
      <button class="blue" onclick="nextWord()">â¡</button>
    </div>
    <!-- ãƒ¢ãƒ¼ãƒ‰æ“ä½œ -->
    <div class="row">
      <button id="playAll" class="blue">â–¶All</button>
      <button class="orange" onclick="shuffleWord()">ğŸ²</button>
      <button class="green" onclick="toggleKnown()">âœ…</button>
    </div>
  </div>

  <audio id="audio"></audio>

  <!-- ğŸ“– å˜èªãƒªã‚¹ãƒˆ -->
  <h3>å˜èªãƒªã‚¹ãƒˆ</h3>
  <label>
    <input type="checkbox" id="filterUnknown"> è¦šãˆã¦ãªã„å˜èªã ã‘è¡¨ç¤º
  </label>
  <div id="wordList" class="list"></div>

  <script>
    let words = [];
    let currentIndex = 0;
    let isPlaying = false;
    let audio = document.getElementById("audio");
    let knownWords = JSON.parse(localStorage.getItem("knownWords") || "{}");
    let renderIndex = 0;
    const batchSize = 50;

    // =================
    // JSON èª­ã¿è¾¼ã¿
    // =================
    fetch("words.json")
      .then(res => res.json())
      .then(data => {
        words = data;
        updateWord();      // åˆæœŸè¡¨ç¤º
        refreshList();     // ãƒªã‚¹ãƒˆæç”»
      });

    // =================
    // ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    // =================
    function updateWord() {
      if (words.length === 0) return;
      const w = words[currentIndex];
      document.getElementById("wordTitle").innerText = w.id + ". " + w.word;
      document.getElementById("wordImage").src = w.image;
    }

    function togglePlay() {
      if (words.length === 0) return;
      const w = words[currentIndex];
      if (!isPlaying) {
        audio.src = w.audio;
        audio.play();
        isPlaying = true;
      } else {
        audio.pause();
        audio.currentTime = 0;
        isPlaying = false;
      }
    }

    function prevWord() {
      if (words.length === 0) return;
      currentIndex = (currentIndex - 1 + words.length) % words.length;
      updateWord();
    }

    function nextWord() {
      if (words.length === 0) return;
      currentIndex = (currentIndex + 1) % words.length;
      updateWord();
    }

    function shuffleWord() {
      if (words.length === 0) return;
      currentIndex = Math.floor(Math.random() * words.length);
      updateWord();
      togglePlay();
    }

    function toggleKnown() {
      if (words.length === 0) return;
      const w = words[currentIndex];
      if (knownWords[w.id]) {
        delete knownWords[w.id];
      } else {
        knownWords[w.id] = true;
      }
      localStorage.setItem("knownWords", JSON.stringify(knownWords));
      refreshList();
    }

    // =================
    // ALLå†ç”Ÿï¼ˆæœªç¿’å¾—ã ã‘ï¼‰
    // =================
    document.getElementById("playAll").onclick = () => {
      if (words.length === 0) return;
      const unknownWords = words.filter(w => !knownWords[w.id]);
      if (unknownWords.length === 0) {
        alert("ğŸ‰ ã™ã¹ã¦è¦šãˆã¦ã„ã¾ã™ï¼");
        return;
      }
      playNextUnknown(unknownWords, 0);
    };

    function playNextUnknown(list, i) {
      if (i >= list.length) return;
      const w = list[i];
      document.getElementById("wordTitle").innerText = w.id + ". " + w.word;
      document.getElementById("wordImage").src = w.image;
      audio.src = w.audio;
      audio.play();
      audio.onended = () => playNextUnknown(list, i + 1);
    }

    function setSpeed(rate) {
      audio.playbackRate = rate;
    }

    // =================
    // å˜èªãƒªã‚¹ãƒˆ
    // =================
    function renderNextBatch() {
      const listEl = document.getElementById("wordList");
      const filterUnknown = document.getElementById("filterUnknown").checked;
      const end = Math.min(renderIndex + batchSize, words.length);

      for (let i = renderIndex; i < end; i++) {
        const w = words[i];
        const isKnown = !!knownWords[w.id];
        if (filterUnknown && isKnown) continue;

        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div class="word-left">
            <span>${w.id}. ${w.word}</span>
            <span class="play-icon" data-audio="${w.audio}">ğŸ”Š</span>
          </div>
          <input type="checkbox" data-id="${w.id}" ${isKnown ? "checked" : ""}>
        `;
        listEl.appendChild(div);
      }
      renderIndex = end;

      // âœ… ãƒã‚§ãƒƒã‚¯ä¿å­˜
      listEl.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.onchange = (e) => {
          const id = e.target.getAttribute("data-id");
          if (e.target.checked) {
            knownWords[id] = true;
          } else {
            delete knownWords[id];
          }
          localStorage.setItem("knownWords", JSON.stringify(knownWords));
        };
      });

      // ğŸ”Š å†ç”Ÿ
      listEl.querySelectorAll(".play-icon").forEach(icon => {
        icon.onclick = (e) => {
          const audioSrc = e.target.getAttribute("data-audio");
          const tmpAudio = new Audio(audioSrc);
          tmpAudio.play();
        };
      });
    }

    function refreshList() {
      const listEl = document.getElementById("wordList");
      listEl.innerHTML = "";
      renderIndex = 0;
      renderNextBatch();
    }

    document.getElementById("wordList").addEventListener("scroll", (e) => {
      const listEl = e.target;
      if (listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 5) {
        renderNextBatch();
      }
    });

    document.getElementById("filterUnknown").addEventListener("change", refreshList);
  </script>
</body>
</html>
