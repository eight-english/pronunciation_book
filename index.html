<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™ºéŸ³å­¦ç¿’è€…ã®å¿…ä¿®å˜èªå¸³</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    h1 {
      margin-top: 10px;
    }
    img {
      max-width: 90%;
      height: auto;
      margin: 20px 0;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    button {
      font-size: 1.2em;
      padding: 12px 18px;
      flex: 1;
    }
    /* å˜èªãƒªã‚¹ãƒˆ */
    .list {
      max-width: 600px;
      margin: 10px auto;
      text-align: left;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 1.1em;
    }
    .word-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .word-name {
      cursor: pointer;
      color: #007BFF;
    }
    .word-name:hover {
      text-decoration: underline;
    }
    .play-icon {
      cursor: pointer;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <h1>ç™ºéŸ³å­¦ç¿’è€…ã®å¿…ä¿®å˜èªå¸³</h1>

  <h2 id="wordTitle">Word Player</h2>
  <img id="wordImage" src="" alt="Word image">

  <!-- ğŸ›ï¸ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
  <div class="controls">
    <div class="row">
      <button onclick="prevWord()">â¬…</button>
      <button onclick="togglePlay()">â–¶ï¸</button>
      <button onclick="nextWord()">â¡</button>
    </div>
    <div class="row">
      <button id="playAll">â–¶All</button>
      <button onclick="shuffleWord()">ğŸ²</button>
      <button onclick="toggleKnown()">âœ…</button>
    </div>
  </div>

  <audio id="audio"></audio>

  <!-- ğŸ“– å˜èªãƒªã‚¹ãƒˆ -->
  <h3>å˜èªãƒªã‚¹ãƒˆ</h3>
  <label>
    <input type="checkbox" id="filterUnknown"> è¦šãˆã¦ãªã„å˜èªã ã‘è¡¨ç¤º
  </label>
  <div id="wordList" class="list"></div>

  <script>
    let words = [];
    let currentIndex = 0;
    let isPlaying = false;
    let audio = document.getElementById("audio");
    let knownWords = JSON.parse(localStorage.getItem("knownWords") || "{}");
    let renderIndex = 0;
    const batchSize = 50;

    // =================
    // words.json ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã§èª­ã¿è¾¼ã¿
    // =================
    fetch("words.json?v=" + new Date().getTime())
      .then(response => response.json())
      .then(data => {
        words = data;
        updateWord();
        renderNextBatch();
      });

    // =================
    // ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    // =================
    function updateWord() {
      const w = words[currentIndex];
      if (!w) return;
      document.getElementById("wordTitle").innerText = w.id + ". " + w.word;
      document.getElementById("wordImage").src = w.image;
    }

    function togglePlay() {
      const w = words[currentIndex];
      if (!isPlaying) {
        audio.src = w.audio;
        audio.play();
        isPlaying = true;
      } else {
        audio.pause();
        audio.currentTime = 0;
        isPlaying = false;
      }
    }

    function prevWord() {
      currentIndex = (currentIndex - 1 + words.length) % words.length;
      isPlaying = false;
      audio.pause();
      updateWord();
    }

    function nextWord() {
      currentIndex = (currentIndex + 1) % words.length;
      isPlaying = false;
      audio.pause();
      updateWord();
    }

    function shuffleWord() {
      currentIndex = Math.floor(Math.random() * words.length);
      isPlaying = false;
      audio.pause();
      updateWord();
      togglePlay();
    }

    function toggleKnown() {
      const w = words[currentIndex];
      if (knownWords[w.id]) {
        delete knownWords[w.id];
      } else {
        knownWords[w.id] = true;
      }
      localStorage.setItem("knownWords", JSON.stringify(knownWords));
      refreshList();
    }

    // =================
    // ALLå†ç”Ÿï¼ˆæœªç¿’å¾—ã ã‘ï¼‰
    // =================
    document.getElementById("playAll").onclick = () => {
      const unknownWords = words.filter(w => !knownWords[w.id]);
      if (unknownWords.length === 0) {
        alert("ğŸ‰ ã™ã¹ã¦è¦šãˆã¦ã„ã¾ã™ï¼");
        return;
      }
      let i = 0;
      playNextUnknown(unknownWords, i);
    };

    function playNextUnknown(list, i) {
      if (i >= list.length) return;
      const w = list[i];
      document.getElementById("wordTitle").innerText = w.id + ". " + w.word;
      document.getElementById("wordImage").src = w.image;
      audio.src = w.audio;
      audio.play();
      audio.onended = () => playNextUnknown(list, i + 1);
    }

    // =================
    // å˜èªãƒªã‚¹ãƒˆ
    // =================
    function renderNextBatch() {
      const listEl = document.getElementById("wordList");
      const filterUnknown = document.getElementById("filterUnknown").checked;
      const end = Math.min(renderIndex + batchSize, words.length);

      for (let i = renderIndex; i < end; i++) {
        const w = words[i];
        const isKnown = !!knownWords[w.id];
        if (filterUnknown && isKnown) continue;

        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div class="word-left">
            <span class="word-name" data-index="${i}">${w.id}. ${w.word}</span>
            <span class="play-icon" data-audio="${w.audio}">ğŸ”Š</span>
          </div>
          <input type="checkbox" data-id="${w.id}" ${isKnown ? "checked" : ""}>
        `;
        listEl.appendChild(div);

        // å˜èªã‚¯ãƒªãƒƒã‚¯ã§ã‚¸ãƒ£ãƒ³ãƒ—
        div.querySelector(".word-name").onclick = (e) => {
          currentIndex = parseInt(e.target.getAttribute("data-index"));
          isPlaying = false;
          audio.pause();
          updateWord();
        };
      }
      renderIndex = end;

      // âœ… ãƒã‚§ãƒƒã‚¯ä¿å­˜
      listEl.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.onchange = (e) => {
          const id = e.target.getAttribute("data-id");
          if (e.target.checked) {
            knownWords[id] = true;
          } else {
            delete knownWords[id];
          }
          localStorage.setItem("knownWords", JSON.stringify(knownWords));
        };
      });

      // ğŸ”Š å†ç”Ÿ
      listEl.querySelectorAll(".play-icon").forEach(icon => {
        icon.onclick = (e) => {
          const audioSrc = e.target.getAttribute("data-audio");
          const tmpAudio = new Audio(audioSrc);
          tmpAudio.play();
        };
      });
    }

    function refreshList() {
      const listEl = document.getElementById("wordList");
      listEl.innerHTML = "";
      renderIndex = 0;
      renderNextBatch();
    }

    document.getElementById("wordList").addEventListener("scroll", (e) => {
      const listEl = e.target;
      if (listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 5) {
        renderNextBatch();
      }
    });

    document.getElementById("filterUnknown").addEventListener("change", refreshList);
  </script>
</body>
</html>
